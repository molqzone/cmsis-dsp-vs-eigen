# 项目上下文

## 1. 基本信息

```yaml
名称: cmsis-dsp-vs-eigen
描述: 在 STM32F407 Cortex-M4F 平台对 Eigen 与 CMSIS-DSP 做矩阵运算性能基准测试
类型: 嵌入式固件/算法基准工程
状态: 开发中（Debug 闭环已落地，等待工具链构建与板级验收）
```

## 2. 技术上下文

```yaml
语言: C11 + C++17
框架: STM32Cube HAL + FreeRTOS + LibXR + CMSIS-DSP
包管理器: 无统一包管理（源码仓库内置第三方依赖）
构建工具: CMake + Ninja + starm-clang
```

### 主要依赖
| 依赖 | 版本 | 用途 |
|------|------|------|
| STM32 HAL | STM32F4 系列版本（仓库内） | 外设驱动与底层硬件初始化 |
| CMSIS-DSP | 仓库内置版本 | 矩阵与 DSP 优化实现，作为对比对象 |
| Eigen | 仓库内置版本（LibXR 子目录） | C++ 模板矩阵运算实现，作为对比对象 |
| LibXR | 仓库内置版本 | 平台抽象与应用层组件 |
| FreeRTOS | 仓库内置版本 | 任务调度与运行时支持 |

## 3. 项目概述

### 核心功能
- 固定入口 `defaultTask -> app_main` 执行基准主流程
- 固定输出通道为 USB CDC（OTG FS），等待 DTR 后开始输出
- 在 Cortex-M4F 上测试 Eigen 与 CMSIS-DSP 的矩阵乘法（3~64）与求逆（3~10）
- 使用 DWT 统计 CPU 周期、扣除计时开销、执行误差校验并输出 CSV

### 项目边界
```yaml
范围内:
  - Debug 闭环阶段的可运行性、可重复性与数据完整性验证
  - 固定矩阵规模分组测试（乘法 8 个尺寸、求逆 5 个尺寸）
  - 结果有效性校验（Frobenius 误差阈值、计时开销扣除、valid/invalid 统计）
范围外:
  - Debug 阶段的正式性能结论发布
  - 非矩阵类 DSP 算法基准
  - 与 Cortex-M4F 无关的架构优化结论
```

## 4. 开发约定

### 代码规范
```yaml
命名风格: C 侧下划线风格 + C++ 类型使用大驼峰
文件命名: 平台/驱动文件按 stm32_* 与模块职责命名
目录组织: Core/Drivers/Middlewares/User 分层
```

### 错误处理
```yaml
错误码格式: 以库返回值或 HAL 状态码为主
日志级别: 当前以串口输出为主，未定义统一分级
```

### 测试要求
```yaml
测试框架: 当前无独立 tests 框架（以板级基准程序验证）
覆盖率要求: 未定义
测试文件位置: 主要在 User/ 与第三方库自带测试目录
```

### Git规范
```yaml
分支策略: 未在仓库内显式定义（建议 feature 分支 + 合并）
提交格式: 未在仓库内显式定义
```

## 5. 当前约束（源自历史决策）

> 这些是当前生效的技术约束，详细来源见 PLAN.md 与工具链配置

| 约束 | 原因 | 决策来源 |
|------|------|---------|
| 目标平台固定为 Cortex-M4F + 硬浮点 | 确保测试可比性，突出嵌入式场景 | PLAN.md |
| 计时使用 DWT 周期计数并扣除基线开销 | 避免测量开销污染结论 | PLAN.md |
| 矩阵数据要求行优先与静态分配 | 保证 Eigen 与 CMSIS-DSP 对比公平 | PLAN.md |
| 输出通道固定为 USB CDC（OTG FS） | 避免 UART 路径干扰，统一日志口径 | 落地方案与 app_main 实现 |
| Debug 阶段必须打印非正式结论警示 | 防止误用 Debug 结果做性能定论 | 落地方案与 benchmark_runner 实现 |
| 编译工具链为 starm-clang + CMake | 与当前工程构建系统保持一致 | cmake/starm-clang.cmake |

## 6. 已知技术债务（可选）

> 主动识别的需要未来处理的技术问题

| 债务描述 | 优先级 | 来源 | 建议处理时机 |
|---------|--------|------|-------------|
| 本环境缺少 `starm-clang`，尚未完成真实编译与板级验收 | P0 | 当前执行环境 | 用户本机具备工具链后立即执行 |
| `BENCHMARK_PERF_MODE` 仍默认 `OFF`，尚未开展 O3/LTO 正式采样 | P1 | 当前阶段策略 | Debug 闭环通过后启用 |
| 缺少自动化解析 CSV 并生成图表/统计报告脚本 | P1 | 项目结构扫描 | 正式性能实验阶段 |
